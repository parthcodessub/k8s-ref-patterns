apiVersion: v1
kind: ServiceAccount
metadata:
  name: otel-collector
  namespace: default

---
# 1. RBAC: Allow Collector to "scan" the cluster for pods
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: otel-collector
rules:
- apiGroups: [""]
  resources: ["pods", "nodes", "nodes/proxy"]
  verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: otel-collector
subjects:
- kind: ServiceAccount
  name: otel-collector
  namespace: default
roleRef:
  kind: ClusterRole
  name: otel-collector
  apiGroup: rbac.authorization.k8s.io

---
# 2. Config: Define Discovery & Export logic
apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-agent-conf
data:
  otel-config.yaml: |
    receivers:
      prometheus:
        config:
          scrape_configs:
            - job_name: 'kubernetes-pods'
              scrape_interval: 10s
              kubernetes_sd_configs:
                - role: pod
              
              relabel_configs:
                # 1. Only scrape if annotation prometheus.io/scrape = true
                - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
                  action: keep
                  regex: true

                # 2. Extract the path from annotation
                - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
                  action: replace
                  target_label: __metrics_path__
                  regex: (.+)
                
                # REMOVED: Manual Address Construction
                # We saw in debug logs that __address__ is already correct (10.x.x.x:2112)
                # because the Deployment defines containerPort: 2112.
                # Overwriting it was causing the failure.

    processors:
      batch:

    exporters:
      # DEBUG: Print metrics to stdout so we can see them in kubectl logs
      debug:
        verbosity: detailed
      # Write to a local file in the container for verification
      file:
        path: /tmp/daemonset-metrics.json
        rotation:
          max_megabytes: 10

    service:
      pipelines:
        metrics:
          receivers: [prometheus]
          processors: [batch]
          exporters: [file, debug]

---
# 3. The DaemonSet
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: otel-collector-agent
  labels:
    app: otel-collector
spec:
  selector:
    matchLabels:
      app: otel-collector
  template:
    metadata:
      labels:
        app: otel-collector
    spec:
      serviceAccountName: otel-collector
      containers:
        - name: otel-collector
          image: otel/opentelemetry-collector-contrib:0.88.0
          command: ["/otelcol-contrib"]
          args: ["--config=/conf/otel-config.yaml"]
          volumeMounts:
            - name: otel-config-vol
              mountPath: /conf
            # Mount a writable volume to /tmp to fix "permission denied"
            - name: tmp-vol
              mountPath: /tmp
      volumes:
        - name: otel-config-vol
          configMap:
            name: otel-agent-conf
        - name: tmp-vol
          emptyDir: {}